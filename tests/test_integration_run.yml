# Test the pipeline with an empty vcf file
- name: integration-empty
  tags:
    - integration
  command: >
    snakemake
      --reason
      --printshellcmds
      --jobs 1
      --latency-wait 120
      --use-singularity --singularity-args ' --cleanenv --bind /tmp'
      --config
        pepfile=tests/pep/project_config_empty.yaml
        reference=tests/data/ref.fa
      --snakefile Snakefile
  files:
    - path: sample1/combinations/0_A.vcf.gz
    - path: sample1/combinations/0_B.vcf.gz
    - path: sample1/sample1_no_homref.vcf
    - path: sample1/fasta/0_A_all.fasta
    - path: sample1/fasta/0_B_all.fasta
    - path: sample1/final_files.txt
      contains:
        - 0_A_all.seq
        - 0_B_all.seq

# Test the pipeline with an unphased vcf file
- name: integration-unphased
  tags:
    - integration
  command: >
    snakemake
      --reason
      --printshellcmds
      --jobs 1
      --latency-wait 120
      --use-singularity --singularity-args ' --cleanenv --bind /tmp'
      --config
        pepfile=tests/pep/project_config_unphased.yaml
        reference=tests/data/ref.fa
      --snakefile Snakefile
  files:
    - path: sample2/combinations/0_A.vcf.gz
    - path: sample2/combinations/0_B.vcf.gz

# Test the pipeline with a phased vcf file
- name: integration-phased
  tags:
    - integration
  command: >
    snakemake
      --reason
      --printshellcmds
      --jobs 1
      --latency-wait 120
      --use-singularity --singularity-args ' --cleanenv --bind /tmp'
      --config
        pepfile=tests/pep/project_config_phased.yaml
        reference=tests/data/ref.fa
      --snakefile Snakefile
  files:
    - path: sample3/combinations/0_A.vcf.gz
    - path: sample3/combinations/1_A.vcf.gz
    - path: sample3/combinations/0_B.vcf.gz
    - path: sample3/combinations/1_B.vcf.gz
    - path: sample3/final_files.txt
      contains:
        - 0_A_all.seq
        - 1_A_all.seq
        - 0_B_all.seq
        - 1_B_all.seq

# Test the pipeline in a specific chromosome
- name: integration-region-chrM
  tags:
    - integration
  command: >
    snakemake
      --reason
      --printshellcmds
      --jobs 1
      --latency-wait 120
      --use-singularity --singularity-args ' --cleanenv --bind /tmp'
      --config
        pepfile=tests/pep/project_config_phased.yaml
        reference=tests/data/ref.fa
        region=chrM
      --snakefile Snakefile
  stderr:
    contains:
      # Here we use a bash test in the shell to check if a region was specified
      - "[ -z chrM ]"
  files:
    # Test that we applied all variants in chrM
    - path: log/sample3_fasta_0_A.txt
      contains:
      - Applied 16 variants

# Test the pipeline in a region of a specific chromosome
- name: integration-region-chrM-start
  tags:
    - integration
  command: >
    snakemake
      --reason
      --printshellcmds
      --jobs 1
      --latency-wait 120
      --use-singularity --singularity-args ' --cleanenv --bind /tmp'
      --config
        pepfile=tests/pep/project_config_phased.yaml
        reference=tests/data/ref.fa
        region=chrM:1-545
      --snakefile Snakefile
  stderr:
    contains:
      # Here we use a bash test in the shell to check if a region was specified
      - "[ -z chrM:1-545 ]"
  files:
    # Test that we applied only the variants at the start of chrM
    - path: log/sample3_fasta_0_A.txt
      contains:
        - Applied 3 variants
    # Test if boundary variants are included/excluded based on the specified
    # region
    - path: sample3/sample3_no_homref.vcf
      contains:
        - "chrM\t539"
      must_not_contain:
        - "chrM\t750"

# Test the pipeline with multiple samples
- name: integration-two-samples
  tags:
    - integration
  command: >
    snakemake
      --reason
      --printshellcmds
      --jobs 1
      --latency-wait 120
      --use-singularity --singularity-args ' --cleanenv --bind /tmp'
      --config
        pepfile=tests/pep/project_config_two_samples.yaml
        reference=tests/data/ref.fa
        region=chrM:1-545
      --snakefile Snakefile
  files:
    # Test that we applied only the variants at the start of chrM
    - path: sample1/final_files.txt
    - path: sample2/final_files.txt
